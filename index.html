<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Lägg till denna länk i din head-tagg -->
    <link href="https://fonts.googleapis.com/css2?family=Exo+2&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="style.css">

</head>

<body>

    <!-- Loader HTML -->
    <div class="blocks" id="loader" hidden>
        <div class="block orange"></div>
        <div class="block blue"></div>
    </div>

    <!-- Överlägg för att mörkna och sudda ut bakgrunden när loadern visas -->
    <div id="overlay" hidden></div>




    <nav class="nav">
        <input class="nav__trigger-input" type="checkbox" id="trigger" aria-label="open the navigation" />
        <label class="nav__trigger-finger" for="trigger">
            <span></span>
        </label>
        <ul class="nav__list">
            <li class="nav__item">
                <a href="#hoi" class="nav__link">
                    <span class="nav__text">
                        Startsida
                    </span>
                </a>
            </li>
            <li class="nav__item">
                <a href="#hoi" class="nav__link">
                    <span class="nav__text">
                        Om
                    </span>
                </a>
                <input class="nav__submenu-trigger-input" type="checkbox" id="submenu-trigger" />
                <label class="nav__submenu-trigger-finger" for="submenu-trigger"></label>
                <ul class="nav__list-child">
                    <li class="nav__item">
                        <a href="#hoi" class="nav__link">
                            <span class="nav__text">
                                Om oss
                            </span>
                        </a>
                    </li>
                    <li class="nav__item">
                        <a href="#hoi" class="nav__link">
                            <span class="nav__text">
                                Tipsa Oss
                            </span>
                        </a>
                    </li>
                </ul>
            </li>
            <li class="nav__item">
                <a href="#hoi" class="nav__link">
                    <span class="nav__text">
                        Blogg
                    </span>
                </a>
                <input class="nav__submenu-trigger-input" type="checkbox" id="submenu-trigger" />
                <label class="nav__submenu-trigger-finger" for="submenu-trigger"></label>
                <ul class="nav__list-child">
                    <li class="nav__item">
                        <a href="#hoi" class="nav__link">
                            <span class="nav__text">
                                Knivar & Kastruller
                            </span>
                        </a>
                    </li>
                    <li class="nav__item">
                        <a href="#hoi" class="nav__link">
                            <span class="nav__text">
                                Inredning
                            </span>
                        </a>
                    </li>
                </ul>
            </li>
            <!-- <li class="nav__item">
                <a href="#hoi" class="nav__link">
                    <span class="nav__text">
                        Blogg
                    </span>
                </a>
            </li> -->
            <li class="nav__item">
                <a href="#hoi" class="nav__link">
                    <span class="nav__text">
                        Kontakt
                    </span>
                </a>
            </li>
        </ul>
    </nav>

    <a href="index.html" class="logo-link">
        <img src="images/visplogo/Logo Files/For Web/svg/White logo - no background.svg" alt="Logga" />
    </a>

    <div class="background-container"></div>

    <!-- Logotyp Container -->
    <div class="logo-container" style="text-align: center; margin-top: 20px;">
        <img src="images/visplogo/Logo Files/For Web/svg/Black logo - no background.svg" alt="Logotyp" class="logo-image">

    </div>

    <div class="search-container">
        <!-- Ny slider här 
        <div class="search-mode-container">
            <div class="search-mode-label">←Sök på ingredienser</div>
            <label class="switch large">
                <input type="checkbox" id="searchModeSwitch" onchange="toggleSearchMode()">
                <span class="slider round large"></span>
            </label>
            <div class="search-mode-label">Sök på maträtt→</div>
        </div> -->
        <!-- Slider-knappar ovanför sökfältet -->
        <div class="slider-button-container">
            <div class="veg-container">
                <div class="veg-label">Bara Veg</div>
                <label class="switch">
                    <input type="checkbox" id="vegSwitch" onchange="toggleVegFilter()">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="lang-container">
                <div class="lang-label">Bara recept på svenska</div>
                <label class="switch">
                    <input type="checkbox" id="langSwitch" onchange="toggleLangFilter()">
                    <span class="slider round"></span>
                </label>
            </div>
        </div>

        <!-- Sökfält och knappar -->
        <div class="input-button-container">
            <input type="text" id="searchInput" placeholder="Skriv ingredienser o tryck Enter...">
            <button onclick="addTagFromButton()" class="add-button">
                <img src="images/knifeforksign.jpg
                " alt="Add" />
            </button> <!-- Ny knapp för att lägga till taggar -->
            <!-- <button onclick="performSearch()">Sök</button> -->
        </div>

        <!-- Taggarna här -->
        <div class="tag-container"></div>
    </div>


    <div id="data-container" class="initial"></div>

    <div id="pagination-controls"></div>

    <div class="footer-banner">
        <!-- Footer content -->
        <!-- Innehåll för din banner, t.ex. Om Oss och Tipsa Oss länkar -->
    </div>

    <script>

        const apiKey = 'AIzaSyBFecFz9KFsPnw6bjAKv0N0CSbs3Iszlag';
        const spreadsheetId = '1RN9SQRzletJnH8BAgJEQCI0BtbpsHQU6Pv2L4FDGXEM';
        const dataRange = 'Blad1!A2:J';
        const synonymRange = 'Ingredienser!A2:B';
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${dataRange}?key=${apiKey}`;
        const synonymUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${synonymRange}?key=${apiKey}`;

        let allData = [];
        let currentFilteredData = []; // Ny global variabel för att hålla den aktuellt filtrerade datan
        let selectedTags = [];
        let isVegFilterActive = false;
        let isLangFilterActive = false;
        let ingredientSynonyms = {};
        let searchForDishes = false; // eller true, beroende på din standardinställning
        let primaryIngredients = {};
        let nonPrimarySynonyms = {};
        let groupedIngredients = {};
        // Lägg till dessa nya variabler för sidindelning
        let currentPage = 1;
        const resultsPerPage = 15;
        let totalPages = 0;




        async function loadData() {
            try {
                // Load the main data as before
                const dataResponse = await fetch(dataUrl);
                const data = await dataResponse.json();
                allData = data.values; // Assume this includes all your recipe data
                console.log('Main data loaded:', allData);

                // Load synonym data
                const synonymResponse = await fetch(synonymUrl);
                const synonymData = await synonymResponse.json();
                primaryIngredients = {}; // Reset the mapping object for primary ingredients
                nonPrimarySynonyms = {}; // Reset the mapping object for non-primary synonyms
                synonymData.values.forEach(row => {
                    const ingredient = row[0]?.toLowerCase().trim(); // Ingredient
                    const synonyms = row[1]?.toLowerCase().split(',').map(s => s.trim()); // Synonyms
                    if (row[2]?.toLowerCase() === 'ja') {
                        primaryIngredients[ingredient] = synonyms;
                    } else {
                        nonPrimarySynonyms[ingredient] = synonyms;
                    }
                });
                console.log('Primary ingredients loaded:', primaryIngredients);
                console.log('Non-primary synonyms loaded:', nonPrimarySynonyms);

                // Load data for grouped ingredients
                const groupedIngResponse = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Ingredienser!A2:C?key=${apiKey}`);
                const groupedIngData = await groupedIngResponse.json();
                groupedIngredients = {};
                groupedIngData.values.forEach(row => {
                    const searchTerm = row[1]?.toLowerCase().trim(); // Search term from column B
                    const ingredientsGroup = row[2]?.toLowerCase().split(',').map(ing => ing.trim()); // Grouped ingredients from column C
                    if (ingredientsGroup && ingredientsGroup.length > 0) {
                        groupedIngredients[searchTerm] = ingredientsGroup;
                    }
                });
                console.log('Grouped ingredients loaded:', groupedIngredients);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }



        async function loadSynonyms() {
            try {
                const synonymResponse = await fetch(synonymUrl);
                const synonymData = await synonymResponse.json();

                // Logga ut hela synonymData-objektet för att se vad som faktiskt laddas
                console.log('Synonym data:', synonymData);

                // Kontrollera om synonymData.values är definierat och är en array
                if (Array.isArray(synonymData.values)) {
                    ingredientSynonyms = {}; // Återställ mappningsobjektet för synonymer

                    synonymData.values.forEach(row => {
                        // Kontrollera att varje rad har två element
                        if (row.length >= 2) {
                            const ingredients = row[0]?.toLowerCase().trim(); // Huvudingredienserna
                            const searchTerms = row[1]?.toLowerCase().split(',').map(s => s.trim()); // Sökorden

                            // Skapa en omvänd lookup där varje sökterm pekar på huvudingrediensen
                            searchTerms.forEach(term => {
                                ingredientSynonyms[term] = ingredients;
                            });
                        } else {
                            console.error('Invalid row format:', row);
                        }
                    });

                    console.log('Synonyms and search terms loaded:', ingredientSynonyms);
                } else {
                    console.error('synonymData.values is not an array:', synonymData.values);
                }
            } catch (error) {
                console.error('Error loading synonyms:', error);
            }
        }



        async function performSearch() {
            // Visa loadern och överlägget
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('overlay').style.display = 'block'; // Visa överlägget

            // Sätt en timer för att dölja både loadern och överlägget efter 3 sekunder
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('overlay').style.display = 'none'; // Dölj överlägget
            }, 3000); // 3000 ms = 3 sekunder
            currentPage = 1; // Återställer till första sidan vid varje ny sökning
            let searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            console.log('Search term:', searchTerm);
            let filteredData = allData; // Använd allData som utgångspunkt

            if (searchForDishes) {
                // Search based on dish name
                filteredData = allData.filter(row => row[0].toLowerCase().includes(searchTerm));

                // Filter for Vegetarian and Swedish recipes if activated
                if (isVegFilterActive) {
                    filteredData = filteredData.filter(row => row[6]?.toLowerCase() === 'ja');
                }
                if (isLangFilterActive) {
                    filteredData = filteredData.filter(row => row[7]?.toLowerCase() === 'ja');
                }

                console.log('Filtered data:', filteredData);
            } else {
                // For each selected tag, find matching individual ingredients or grouped ingredients
                let searchIngredients = selectedTags.flatMap(tag => {
                    if (groupedIngredients[tag]) {
                        return groupedIngredients[tag];
                    } else if (ingredientSynonyms[tag]) {
                        let ingredientsArray = ingredientSynonyms[tag].split(', ').map(ing => ing.trim());
                        return ingredientsArray;
                    } else {
                        return [tag];
                    }
                });

                console.log('Ingredients to search for:', searchIngredients);

                filteredData = allData.filter(row => {
                    const ingredients = row[1]?.toLowerCase().split(', ').map(ing => ing.trim());
                    return searchIngredients.every(ingredient => ingredients.includes(ingredient));
                });

                if (isVegFilterActive) {
                    filteredData = filteredData.filter(row => row[6]?.toLowerCase() === 'ja');
                }
                if (isLangFilterActive) {
                    filteredData = filteredData.filter(row => row[7]?.toLowerCase() === 'ja');
                }
            }
            // Efter filtrering, spara den filtrerade listan i currentFilteredData
            currentFilteredData = filteredData;

            // Använd currentFilteredData för att visa den första sidan av sökresultaten
            totalPages = Math.ceil(currentFilteredData.length / resultsPerPage);
            displayData(currentFilteredData, currentPage);



        }


        // Fortsätt med resten av din JavaScript-kod här...




        function addTagFromButton() {
            const inputField = document.getElementById('searchInput');
            const input = inputField.value.trim().toLowerCase();

            if (searchForDishes) {
                console.log("Lägg till knappen är inaktiv när sökning på maträtter är aktiverad");
                return;
            }

            if (input && !selectedTags.includes(input)) {
                selectedTags.push(input);
                updateTagContainer();
            }

            inputField.value = ''; // Rensa inputfältet
        }

        function toggleVegFilter() {
            let vegSwitch = document.getElementById('vegSwitch');
            isVegFilterActive = vegSwitch.checked;
        }

        function toggleLangFilter() {
            let langSwitch = document.getElementById('langSwitch');
            isLangFilterActive = langSwitch.checked;
        }

        function toggleSearchMode() {
            const searchModeSwitch = document.getElementById('searchModeSwitch');
            searchForDishes = searchModeSwitch.checked;
            if (searchForDishes) {
                console.log("Sökning på maträtter aktiverad");
            } else {
                console.log("Sökning på ingredienser aktiverad");
            }
        }

        document.getElementById('searchInput').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = this.value.trim().toLowerCase();

                // Om sökning på maträtter är aktiverad, utför sökningen direkt.
                if (searchForDishes) {
                    performSearch();
                    return;
                }

                // Lägg till tagg om möjligt och utför sökning.
                if (input && !selectedTags.includes(input)) {
                    selectedTags.push(input);
                    updateTagContainer();
                }

                performSearch(); // Utför sökningen direkt efter att en tagg har lagts till eller söktermen angivits.
                this.value = ''; // Rensa inputfältet
            }
        });







        function updateTagContainer() {
            const container = document.querySelector('.tag-container');
            container.innerHTML = selectedTags.map(tag => `
        <div class="tag">
            ${tag}
            <button class="tag-close" onclick="removeTag('${tag}')">×</button>
        </div>
    `).join('');
        }

        function displayData(data, page) {
            var startIndex = (page - 1) * resultsPerPage;
            var endIndex = startIndex + resultsPerPage;
            var pageData = data.slice(startIndex, endIndex);
            var dataContainer = document.getElementById('data-container');
            dataContainer.classList.add('initial');

            var htmlContent = '';
            pageData.forEach((row, index) => {
                htmlContent += `<div class="matratt">`;
                htmlContent += `<div class="matratt-title"><h2>${row[0]}</h2></div>`; // Maträttens namn

                /* // Knapp för att visa ingredienser
                htmlContent += `<button class="ingrediens-knapp" onclick="toggleIngredienser(this)">Visa Ingredienser</button>`;

                // Rullista för ingredienser med mouseleave-händelse
                htmlContent += `<div class="ingrediens-lista" onmouseleave="hideIngredienser(this)">${row[1].split(', ').join('<br>')}</div>`; */

                htmlContent += row[5]; // Instagram-inlägg
                htmlContent += '</div>';
            });

            document.getElementById('data-container').innerHTML = htmlContent;

            // Processa Instagram-inlägg
            if (window.instgrm) {
                window.instgrm.Embeds.process();
            }

            // Visa pagineringskontroller
            displayPaginationControls();

            // Once search is done, hide the loader
            // Consider using a timeout if the search is too fast to show animation
            setTimeout(hideLoader);
        }

        function displayPaginationControls() {
            var paginationHtml = '';
            const pageWindow = 2; // Antal sidor att visa på varje sida om den aktuella sidan
            let startPage = Math.max(currentPage - pageWindow, 1);
            let endPage = Math.min(currentPage + pageWindow, totalPages);

            // Lägg till länk till första sidan och ellips om det behövs
            if (startPage > 1) {
                paginationHtml += `<button onclick="goToPage(1)">1</button>`;
                if (startPage > 2) paginationHtml += `<span>...</span>`; // Ellips för att visa gap
            }

            // Visa sidnummer nära den aktuella sidan
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `<button class="${i === currentPage ? 'current-page' : ''}" onclick="goToPage(${i})">${i}</button>`;
            }

            // Lägg till ellips och länk till sista sidan om det behövs
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) paginationHtml += `<span>...</span>`; // Ellips för att visa gap
                paginationHtml += `<button onclick="goToPage(${totalPages})">${totalPages}</button>`;
            }

            document.getElementById('pagination-controls').innerHTML = paginationHtml;
        }

        function goToPage(pageNumber) {
            currentPage = pageNumber;
            displayData(currentFilteredData, currentPage);

            setTimeout(() => {
                // Ensure that the data container is present in the DOM
                const dataContainer = document.getElementById('data-container');
                if (dataContainer) {
                    dataContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 500); // Adjust timeout as needed
        }





        function toggleIngredienser(button) {
            var ingrediensLista = button.nextElementSibling;
            ingrediensLista.style.display = ingrediensLista.style.display === 'block' ? 'none' : 'block';
        }

        function hideIngredienser(ingrediensLista) {
            ingrediensLista.style.display = 'none';
        }



        window.onload = async function () {
            await loadData();
            await loadSynonyms();
            // Eventuella ytterligare initialiseringar eller funktioner som ska köras efter att data och synonymer har laddats
        };

        window.addEventListener('DOMContentLoaded', function () {
            const searchContainer = document.querySelector('.search-container');
            const tagContainer = document.querySelector('.tag-container');
            let lastScrollTop = 0;

            window.addEventListener('scroll', function () {
                var currentScroll = window.pageYOffset || document.documentElement.scrollTop;

                if (currentScroll > lastScrollTop) {
                    // Användaren scrollar neråt
                    console.log('Scrolling down');
                    searchContainer.style.opacity = '0';
                    searchContainer.style.visibility = 'hidden';
                    tagContainer.style.opacity = '0';
                    tagContainer.style.visibility = 'hidden';
                } else {
                    // Användaren scrollar uppåt
                    console.log('Scrolling up');
                    searchContainer.style.opacity = '1';
                    searchContainer.style.visibility = 'visible';
                    tagContainer.style.opacity = '1';
                    tagContainer.style.visibility = 'visible';
                }
                lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
            }, false);
        });








        function removeTag(tagToRemove) {
            selectedTags = selectedTags.filter(tag => tag !== tagToRemove);
            updateTagContainer(); // Uppdaterar taggkontainern
            performSearch(); // Utför en ny sökning med uppdaterade taggar
        }



    </script>

    <script async src="//www.instagram.com/embed.js"></script>


    <div class="footer-banner">
        <p class="copyright">&copy; 2023. All rights reserved.</p>
        <div class="footer-links">
            <a href="omoss.html">Om</a>
            <a href="tipsaoss.html">Tipsa</a>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const triggerInput = document.querySelector('.nav__trigger-input');
            const searchContainer = document.querySelector('.search-container');
            let lastScrollTop = 0;

            triggerInput.addEventListener('change', () => {
                if (triggerInput.checked) {
                    searchContainer.style.zIndex = '-1';
                } else {
                    searchContainer.style.zIndex = '1000';
                }
            });

        });


    </script>
</body>

</html>